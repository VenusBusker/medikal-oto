name: Otomedikal Dev Haber Guncelleyici
on:
  schedule:
    - cron: '0 * * * *' 
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout depo
        uses: actions/checkout@v3

      - name: Haberleri Cek
        shell: python
        run: |
          import json, os, re, urllib.request, urllib.parse
          from datetime import datetime

          def get_val(item, tag):
              match = re.search(f'<{tag}>(.*?)</{tag}>', item, re.DOTALL)
              return match.group(1) if match else ""

          def fetch(q, lang):
              items = []
              url = f"https://news.google.com/rss/search?q={urllib.parse.quote(q)}&hl={lang}"
              req = urllib.request.Request(url, headers={'User-Agent': 'Mozilla/5.0'})
              with urllib.request.urlopen(req) as resp:
                  content = resp.read().decode('utf-8')
                  matches = re.findall(r'<item>(.*?)</item>', content, re.DOTALL)
                  for it in matches[:20]:
                      items.append({
                          'title': get_val(it, 'title').split(' - ')[0],
                          'link': get_val(it, 'link'),
                          'pubDate': get_val(it, 'pubDate'),
                          'image': '' # Görseli boş bırakıyoruz, JS halledecek
                      })
              return items

          data_en = fetch("medical news", "en-US")
          data_tr = fetch("tıp haberleri", "tr")

          def save(file, items):
              old = []
              if os.path.exists(file):
                  with open(file, 'r', encoding='utf-8') as f:
                      old = json.load(f).get('items', [])
              links = {i['link'] for i in old}
              combined = ([i for i in items if i['link'] not in links] + old)[:300]
              with open(file, 'w', encoding='utf-8') as f:
                  json.dump({"items": combined, "sync": str(datetime.now())}, f, indent=2, ensure_ascii=False)

          save('haberler.json', data_en)
          save('haberler_tr.json', data_tr)

      - name: Kaydet
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Sync: $(date)" || exit 0
          git push origin main
